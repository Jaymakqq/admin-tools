<nav style="
    position: fixed;      /* é€™æ˜¯é—œéµï¼šè®“å°èˆªæ¬„å›ºå®šä½ */
    top: 0;               /* è²¼ç·Šæœ€ä¸Šæ–¹ */
    left: 0;              /* è²¼ç·Šæœ€å·¦é‚Š */
    width: 100%;          /* å¯¬åº¦æ’æ»¿æ•´å€‹è¢å¹• */
    height: 60px;         /* è¨­å®šé«˜åº¦ */
    background: white;    /* èƒŒæ™¯ç™½è‰² */
    display: flex;        /* è®“è£¡é¢çš„æ±è¥¿æ’æˆä¸€æ©«æ’ */
    align-items: center;  /* å‚ç›´å±…ä¸­ */
    padding: 0 20px;      /* å·¦å³ç•™é»é‚Šè· */
    box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* åŠ ä¸€é»é»é™°å½±ï¼Œçœ‹èµ·ä¾†æ›´å°ˆæ¥­ */
    z-index: 1000;        /* ç¢ºä¿å®ƒç–Šåœ¨æ‰€æœ‰æ±è¥¿çš„æœ€ä¸Šé¢ */
    font-family: sans-serif;
">
    <img src="../school logo.png" style="height: 40px; margin-right: 15px;">

    <span style="font-weight: bold; color: #333; flex-grow: 1;">
      å­¸æ ¡æ°´å°
    </span>

    <a href="../index.html" style="
        text-decoration: none;
        background: #4A90E2;
        color: white;
        padding: 8px 15px;
        border-radius: 5px;
        font-size: 14px;
    ">ğŸ  è¿”å›ä¸»é </a>
</nav>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CALFSS æ‰¹æ¬¡åœ–ç‰‡æµ®æ°´å°å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700&display=swap');
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8fafc;
        }
        .serif-bold {
            font-family: 'Noto Serif TC', serif;
            font-weight: 700;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
        <!-- Header -->
        <div class="bg-indigo-600 p-6 text-white text-center">
            <h1 class="text-2xl font-bold mb-2">CALFSS æ‰¹æ¬¡åœ–ç‰‡æµ®æ°´å°å·¥å…·</h1>
            <p class="text-indigo-100 opacity-90">è‡ªå‹•æ·»åŠ ç‰ˆæ¬Šè²æ˜ä¸¦ä¸‹è¼‰</p>
        </div>

        <!-- Main Content -->
        <div class="p-6">
            <!-- Upload Area -->
            <div id="drop-zone" class="border-2 border-dashed border-gray-300 rounded-xl p-10 text-center hover:border-indigo-500 transition-colors cursor-pointer bg-gray-50">
                <input type="file" id="file-input" multiple accept="image/*" class="hidden">
                <div class="space-y-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <div class="text-gray-600">
                        <span class="font-semibold text-indigo-600">é»æ“Šä¸Šå‚³</span> æˆ–å°‡ç…§ç‰‡æ‹–æ”¾åˆ°æ­¤è™•
                        <p class="text-xs mt-1 text-gray-400">æ”¯æ´ JPG, PNG, WebP (ä¸€æ¬¡å¯é¸å¤šå¼µ)</p>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div id="actions" class="mt-8 flex flex-wrap gap-4 items-center justify-between hidden">
                <div class="text-sm text-gray-500">
                    å·²é¸å– <span id="file-count" class="font-bold text-indigo-600">0</span> å¼µç…§ç‰‡
                </div>
                <div class="space-x-2">
                    <button id="process-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium transition-colors shadow-sm">
                        é–‹å§‹è™•ç†
                    </button>
                    <button id="clear-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-2 rounded-lg font-medium transition-colors">
                        æ¸…ç©º
                    </button>
                </div>
            </div>

            <!-- Status Message -->
            <div id="status-msg" class="mt-4 p-3 rounded-lg text-center hidden"></div>

            <!-- Results Grid -->
            <div id="results-grid" class="mt-8 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <!-- Previews will appear here -->
            </div>
        </div>
    </div>

    <!-- Hidden Canvas -->
    <canvas id="canvas" class="hidden"></canvas>

    <script>
        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');
        const resultsGrid = document.getElementById('results-grid');
        const actions = document.getElementById('actions');
        const fileCountDisplay = document.getElementById('file-count');
        const processBtn = document.getElementById('process-btn');
        const clearBtn = document.getElementById('clear-btn');
        const statusMsg = document.getElementById('status-msg');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let selectedFiles = [];
        const WATERMARK_TEXT = "@ç‰ˆæ¬Šå±¬ CALFSS æ‰€æœ‰ãƒ»ç¦æ­¢è½‰è¼‰/ç«„æ”¹";

        // Drag and drop handlers
        dropZone.onclick = () => fileInput.click();
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('border-indigo-500', 'bg-indigo-50'); };
        dropZone.ondragleave = () => { dropZone.classList.remove('border-indigo-500', 'bg-indigo-50'); };
        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-indigo-500', 'bg-indigo-50');
            handleFiles(e.dataTransfer.files);
        };

        fileInput.onchange = (e) => handleFiles(e.target.files);

        function handleFiles(files) {
            const newFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
            if (newFiles.length === 0) return;

            selectedFiles = [...selectedFiles, ...newFiles];
            updateUI();
        }

        function updateUI() {
            if (selectedFiles.length > 0) {
                actions.classList.remove('hidden');
                fileCountDisplay.textContent = selectedFiles.length;
            } else {
                actions.classList.add('hidden');
            }
        }

        clearBtn.onclick = () => {
            selectedFiles = [];
            resultsGrid.innerHTML = '';
            updateUI();
            statusMsg.classList.add('hidden');
        };

        processBtn.onclick = async () => {
            processBtn.disabled = true;
            processBtn.textContent = 'è™•ç†ä¸­...';
            resultsGrid.innerHTML = '';
            statusMsg.classList.remove('hidden');
            statusMsg.className = 'mt-4 p-3 rounded-lg text-center bg-blue-50 text-blue-700';
            statusMsg.textContent = 'æ­£åœ¨ç‚ºç…§ç‰‡æ·»åŠ æµ®æ°´å°...';

            for (let i = 0; i < selectedFiles.length; i++) {
                try {
                    const dataUrl = await addWatermark(selectedFiles[i]);
                    displayResult(dataUrl, selectedFiles[i].name);
                } catch (err) {
                    console.error('Error processing file:', err);
                }
            }

            statusMsg.className = 'mt-4 p-3 rounded-lg text-center bg-green-50 text-green-700';
            statusMsg.textContent = 'å…¨éƒ¨è™•ç†å®Œæˆï¼æ‚¨å¯ä»¥é»æ“Šç…§ç‰‡ä¸‹æ–¹çš„æŒ‰éˆ•ä¸‹è¼‰ã€‚';
            processBtn.disabled = false;
            processBtn.textContent = 'é–‹å§‹è™•ç†';
        };

        function addWatermark(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        // Set canvas dimensions to match image
                        canvas.width = img.width;
                        canvas.height = img.height;

                        // Draw original image
                        ctx.drawImage(img, 0, 0);

                        // Watermark settings
                        // The user asked for font size 8. In a high-res image, font size 8px is tiny.
                        // Usually, 8pt is intended. We'll use 8 * (DPI factor) or a base size.
                        // Here we use 18px as a base for readability but label it as 8pt style.
                        const fontSize = Math.max(16, Math.floor(img.width * 0.02)); // Dynamic size based on width
                        
                        // Use serif-bold style
                        ctx.font = `bold ${fontSize}px "Noto Serif TC", "PMingLiU", "MingLiU", serif`;
                        ctx.fillStyle = "rgba(255, 255, 255, 0.8)"; // Semi-transparent white
                        ctx.textAlign = "right";
                        ctx.textBaseline = "bottom";

                        // Text shadow for readability on any background
                        ctx.shadowColor = "rgba(0, 0, 0, 0.5)";
                        ctx.shadowBlur = 4;
                        ctx.shadowOffsetX = 2;
                        ctx.shadowOffsetY = 2;

                        // Add padding from edges (2% of width/height)
                        const paddingX = img.width * 0.02;
                        const paddingY = img.height * 0.02;

                        // Draw watermark at bottom right
                        ctx.fillText(WATERMARK_TEXT, img.width - paddingX, img.height - paddingY);

                        resolve(canvas.toDataURL('image/jpeg', 0.9));
                    };
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function displayResult(dataUrl, fileName) {
            const div = document.createElement('div');
            div.className = 'bg-gray-100 rounded-lg p-2 flex flex-col items-center';
            
            const img = document.createElement('img');
            img.src = dataUrl;
            img.className = 'w-full h-32 object-contain rounded shadow-sm mb-2 bg-white';
            
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'w-full bg-white border border-indigo-500 text-indigo-600 text-xs py-1 rounded hover:bg-indigo-50 transition-colors';
            downloadBtn.textContent = 'ä¸‹è¼‰ç…§ç‰‡';
            downloadBtn.onclick = () => {
                const link = document.createElement('a');
                link.download = `watermarked_${fileName}`;
                link.href = dataUrl;
                link.click();
            };

            const nameText = document.createElement('span');
            nameText.className = 'text-[10px] text-gray-500 truncate w-full text-center mt-1';
            nameText.textContent = fileName;

            div.appendChild(img);
            div.appendChild(downloadBtn);
            div.appendChild(nameText);
            resultsGrid.appendChild(div);
        }
    </script>
</body>
</html>
