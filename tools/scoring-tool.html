<nav style="
    position: fixed;      /* é€™æ˜¯é—œéµï¼šè®“å°èˆªæ¬„å›ºå®šä½ */
    top: 0;               /* è²¼ç·Šæœ€ä¸Šæ–¹ */
    left: 0;              /* è²¼ç·Šæœ€å·¦é‚Š */
    width: 100%;          /* å¯¬åº¦æ’æ»¿æ•´å€‹è¢å¹• */
    height: 60px;         /* è¨­å®šé«˜åº¦ */
    background: white;    /* èƒŒæ™¯ç™½è‰² */
    display: flex;        /* è®“è£¡é¢çš„æ±è¥¿æ’æˆä¸€æ©«æ’ */
    align-items: center;  /* å‚ç›´å±…ä¸­ */
    padding: 0 20px;      /* å·¦å³ç•™é»é‚Šè· */
    box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* åŠ ä¸€é»é»é™°å½±ï¼Œçœ‹èµ·ä¾†æ›´å°ˆæ¥­ */
    z-index: 1000;        /* ç¢ºä¿å®ƒç–Šåœ¨æ‰€æœ‰æ±è¥¿çš„æœ€ä¸Šé¢ */
    font-family: sans-serif;
">
    <img src="../school logo.png" style="height: 40px; margin-right: 15px;">

    <span style="font-weight: bold; color: #333; flex-grow: 1;">
      è¨ˆåˆ†å·¥å…·
    </span>

    <a href="../index.html" style="
        text-decoration: none;
        background: #4A90E2;
        color: white;
        padding: 8px 15px;
        border-radius: 5px;
        font-size: 14px;
    ">ğŸ  è¿”å›ä¸»é </a>
</nav>
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†çµ„èˆ‡å€‹äººè¨ˆåˆ†å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
        }
        .score-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .bar-transition {
            transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .score-number {
            font-variant-numeric: tabular-nums;
        }
        .tab-active {
            border-bottom: 4px solid #1e293b;
            color: #1e293b;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- é ‚éƒ¨æ¨™é¡Œ -->
        <div class="bg-white rounded-3xl shadow-sm border border-slate-200 p-6 mb-6 text-center">
            <h1 class="text-3xl font-black text-slate-800 flex items-center justify-center gap-2">
                <span class="text-4xl">ğŸ†</span> ç¶œåˆè¨ˆåˆ†å·¥å…·
            </h1>
            <p class="text-slate-500 mt-2 font-medium">ç¨ç«‹ç®¡ç†åˆ†çµ„èˆ‡å€‹äººæ•¸æ“š</p>
        </div>

        <!-- åˆ†é åˆ‡æ› -->
        <div class="flex justify-center mb-8 border-b border-slate-200">
            <button id="tab-group" onclick="switchTab('group')" class="px-8 py-3 font-bold text-slate-400 transition-all tab-active">åˆ†çµ„ç®¡ç†</button>
            <button id="tab-student" onclick="switchTab('student')" class="px-8 py-3 font-bold text-slate-400 transition-all">å€‹äººç®¡ç†</button>
        </div>

        <!-- åˆ†çµ„è¨ˆåˆ†å€å¡Š -->
        <div id="section-group" class="space-y-6">
            <div class="bg-slate-50 p-6 rounded-2xl border border-slate-100 flex flex-wrap items-center justify-center gap-4">
                <div class="flex items-center gap-3 mr-4">
                    <label class="text-slate-600 font-bold">çµ„æ•¸</label>
                    <input type="number" id="group-count" min="1" max="50" value="4" 
                        class="w-16 bg-white border border-slate-200 px-2 py-1 rounded-lg text-xl font-bold text-blue-600 text-center focus:outline-none">
                    <button onclick="generateGroups()" class="bg-slate-800 text-white px-4 py-2 rounded-xl font-bold text-sm">é‡è¨­çµ„åˆ¥</button>
                </div>
                
                <div class="h-8 w-px bg-slate-200 hidden md:block"></div>

                <label class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-xl font-bold cursor-pointer text-sm transition-colors">
                    åŒ¯å…¥ CSV ç´¯è¨ˆ
                    <input type="file" accept=".csv" class="hidden" onchange="handleImport(event, 'group')">
                </label>
                <button onclick="exportData('group')" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2 rounded-xl font-bold text-sm transition-colors">
                    åŒ¯å‡ºåˆ†çµ„ CSV
                </button>
                <button onclick="resetScores('group')" class="bg-rose-100 text-rose-700 hover:bg-rose-200 px-5 py-2 rounded-xl font-bold text-sm transition-colors">
                    é‡è¨­åˆ†æ•¸ (æ­¸é›¶)
                </button>
            </div>
            <div id="groups-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </div>

        <!-- å€‹äººè¨ˆåˆ†å€å¡Š -->
        <div id="section-student" class="hidden space-y-6">
            <div class="bg-slate-50 p-6 rounded-2xl border border-slate-100 flex flex-wrap items-center justify-center gap-4">
                <label class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-xl font-bold cursor-pointer text-sm transition-colors">
                    åŒ¯å…¥/ç´¯è¨ˆåå–®
                    <input type="file" accept=".csv" class="hidden" onchange="handleImport(event, 'student')">
                </label>
                <button onclick="exportData('student')" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2 rounded-xl font-bold text-sm transition-colors">
                    åŒ¯å‡ºå€‹äºº CSV
                </button>
                <button onclick="resetScores('student')" class="bg-rose-100 text-rose-700 hover:bg-rose-200 px-5 py-2 rounded-xl font-bold text-sm transition-colors">
                    é‡è¨­åˆ†æ•¸ (æ­¸é›¶)
                </button>
            </div>
            <div id="students-container" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                <!-- å€‹äººè¨ˆåˆ†å¡ -->
            </div>
        </div>

    </div>

    <script>
        let groups = [];
        let students = [];
        let groupMaxScore = 10;

        const colorSchemes = [
            'from-blue-400 to-blue-600', 'from-emerald-400 to-emerald-600',
            'from-amber-400 to-amber-600', 'from-rose-400 to-rose-600',
            'from-purple-400 to-purple-600', 'from-orange-400 to-orange-600'
        ];

        window.onload = () => {
            generateGroups();
        };

        function switchTab(tab) {
            document.getElementById('section-group').classList.toggle('hidden', tab !== 'group');
            document.getElementById('section-student').classList.toggle('hidden', tab !== 'student');
            document.getElementById('tab-group').classList.toggle('tab-active', tab === 'group');
            document.getElementById('tab-student').classList.toggle('tab-active', tab === 'student');
        }

        // --- åˆ†çµ„é‚è¼¯ ---
        function generateGroups() {
            const count = parseInt(document.getElementById('group-count').value) || 4;
            groups = Array.from({ length: count }, (_, i) => ({
                id: i + 1,
                name: `ç¬¬ ${i + 1} çµ„`,
                score: 0,
                colorClass: colorSchemes[i % colorSchemes.length]
            }));
            updateMaxScore();
            renderGroups();
        }

        function renderGroups() {
            const container = document.getElementById('groups-container');
            container.innerHTML = groups.map(group => {
                const percentage = (group.score / groupMaxScore) * 100;
                return `
                <div class="score-card bg-white rounded-3xl p-6 shadow-sm border border-slate-100">
                    <div class="flex justify-between items-end mb-4">
                        <input type="text" value="${group.name}" onchange="updateName('group', ${group.id}, this.value)"
                            class="text-xl font-bold text-slate-700 bg-transparent border-b-2 border-transparent hover:border-slate-200 focus:border-blue-500 focus:outline-none w-2/3">
                        <div class="score-number text-4xl font-black text-slate-800" id="g-score-${group.id}">${group.score}</div>
                    </div>
                    <div class="w-full bg-slate-100 h-4 rounded-full overflow-hidden mb-6">
                        <div id="g-bar-${group.id}" class="bar-transition h-full bg-gradient-to-r ${group.colorClass}" style="width: ${percentage}%"></div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="changeScore('group', ${group.id}, -1)" class="flex-1 bg-slate-50 text-slate-400 py-3 rounded-xl font-bold hover:bg-rose-50 hover:text-rose-500 transition-colors">-1</button>
                        <button onclick="changeScore('group', ${group.id}, 1)" class="flex-[2] bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900 transition-colors">+1 åˆ†</button>
                    </div>
                </div>`;
            }).join('');
        }

        // --- å€‹äººé‚è¼¯ ---
        function renderStudents() {
            const container = document.getElementById('students-container');
            if (students.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center py-10 text-slate-400 italic font-medium">å°šæœªåŒ¯å…¥äººåæ•¸æ“š</div>';
                return;
            }
            container.innerHTML = students.map(s => `
                <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 flex flex-col items-center">
                    <div class="text-slate-600 font-bold mb-2 truncate w-full text-center px-2" title="${s.name}">${s.name}</div>
                    <div class="score-number text-3xl font-black text-indigo-600 mb-4" id="s-score-${s.id}">${s.score}</div>
                    <div class="flex gap-2 w-full">
                        <button onclick="changeScore('student', ${s.id}, -1)" 
                                class="flex-1 bg-slate-50 text-slate-400 py-1.5 rounded-lg font-bold hover:bg-rose-50 hover:text-rose-500 transition-colors">
                            -1
                        </button>
                        <button onclick="changeScore('student', ${s.id}, 1)" 
                                class="flex-[2] bg-indigo-500 text-white py-1.5 rounded-lg font-bold hover:bg-indigo-600 shadow-sm transition-colors">
                            +1
                        </button>
                    </div>
                </div>`).join('');
        }

        // --- é€šç”¨è¨ˆåˆ† ---
        function changeScore(type, id, delta) {
            const list = type === 'group' ? groups : students;
            const item = list.find(x => x.id === id);
            if (item) {
                item.score = Math.max(0, item.score + delta);
                if (type === 'group') {
                    updateGroupUI(item);
                } else {
                    const el = document.getElementById(`s-score-${id}`);
                    if (el) el.innerText = item.score;
                }
            }
        }

        function updateGroupUI(group) {
            const el = document.getElementById(`g-score-${group.id}`);
            if (el) el.innerText = group.score;
            updateMaxScore();
            groups.forEach(g => {
                const bar = document.getElementById(`g-bar-${g.id}`);
                if (bar) bar.style.width = `${(g.score / groupMaxScore) * 100}%`;
            });
        }

        function updateMaxScore() {
            groupMaxScore = Math.max(10, ...groups.map(g => g.score));
        }

        function updateName(type, id, val) {
            const item = (type === 'group' ? groups : students).find(x => x.id === id);
            if (item) item.name = val;
        }

        // --- åŒ¯å…¥/ç´¯è¨ˆè™•ç† ---
        function handleImport(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const lines = content.split(/\r?\n/).filter(l => l.trim() !== "");
                
                if (type === 'student') {
                    let updatedCount = 0;
                    let addedCount = 0;

                    lines.forEach((line, i) => {
                        if (i === 0 && (line.includes("åç¨±") || line.includes("å§“å"))) return;
                        const parts = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                        
                        let name, scoreToAdd;
                        if (parts.length >= 3 && parts[0].includes("å€‹äºº")) {
                            name = parts[1].replace(/^"|"$/g, '').trim();
                            scoreToAdd = parseInt(parts[2]) || 0;
                        } else {
                            name = parts[0].replace(/^"|"$/g, '').trim();
                            scoreToAdd = parts.length > 1 ? (parseInt(parts[1]) || 0) : 0;
                        }

                        if (!name) return;
                        const existing = students.find(s => s.name === name);
                        if (existing) {
                            existing.score += scoreToAdd;
                            updatedCount++;
                        } else {
                            students.push({ id: Date.now() + i, name, score: scoreToAdd });
                            addedCount++;
                        }
                    });

                    renderStudents();
                    showToast(`å€‹äººåå–®å·²æ›´æ–°: ç´¯è¨ˆ ${updatedCount} äºº, æ–°å¢ ${addedCount} äºº`);
                } else {
                    let groupMatches = 0;
                    for (let i = 0; i < lines.length; i++) {
                        const parts = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                        if (parts.length < 2) continue;

                        let name, score;
                        if (parts[0].includes("åˆ†çµ„") && parts.length >= 3) {
                            name = parts[1].replace(/^"|"$/g, '').trim();
                            score = parseInt(parts[2]) || 0;
                        } else {
                            name = parts[0].replace(/^"|"$/g, '').trim();
                            score = parseInt(parts[1]) || 0;
                        }

                        const targetGroup = groups.find(g => g.name === name);
                        if (targetGroup) {
                            targetGroup.score += score;
                            groupMatches++;
                        }
                    }
                    updateMaxScore();
                    renderGroups();
                    showToast(`åˆ†çµ„æ•¸æ“šå·²ç´¯è¨ˆ ${groupMatches} çµ„`);
                }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        // --- ç¨ç«‹åŒ¯å‡º ---
        function exportData(type) {
            const now = new Date();
            const dateStr = now.toLocaleDateString();
            let csv = "\uFEFFé¡åˆ¥,åç¨±,åˆ†æ•¸,è¨˜éŒ„æ—¥æœŸ\n";
            
            if (type === 'group') {
                groups.forEach(g => csv += `åˆ†çµ„,"${g.name.replace(/"/g, '""')}",${g.score},${dateStr}\n`);
            } else {
                students.forEach(s => csv += `å€‹äºº,"${s.name.replace(/"/g, '""')}",${s.score},${dateStr}\n`);
            }

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `${type === 'group' ? 'åˆ†çµ„' : 'å€‹äºº'}è¨ˆåˆ†_${now.getTime()}.csv`;
            link.click();
        }

        // --- ç¨ç«‹é‡ç½® (å·²ä¿®æ­£ç„¡åæ‡‰å•é¡Œ) ---
        function resetScores(type) {
            // ç›´æ¥åŸ·è¡Œé‡ç½®é€»è¾‘ï¼Œä¸å†ä½¿ç”¨ confirm() é¿å…ç€è¦½å™¨æ””æˆª
            if (type === 'group') {
                groups.forEach(g => g.score = 0);
                updateMaxScore();
                renderGroups();
                showToast("åˆ†çµ„åˆ†æ•¸å·²æ­¸é›¶");
            } else {
                students.forEach(s => s.score = 0);
                renderStudents();
                showToast("å€‹äººåˆ†æ•¸å·²æ­¸é›¶");
            }
        }

        function showToast(msg) {
            const existing = document.querySelector('.toast-msg');
            if (existing) existing.remove();

            const t = document.createElement('div');
            t.className = "toast-msg fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-2xl shadow-xl z-50 font-bold transition-all duration-300 pointer-events-none";
            t.innerText = msg;
            document.body.appendChild(t);
            setTimeout(() => { 
                t.style.opacity = '0'; 
                setTimeout(() => t.remove(), 300); 
            }, 2000);
        }
    </script>
</body>
</html>
