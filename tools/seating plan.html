<nav style="
    position: fixed;      /* é€™æ˜¯é—œéµï¼šè®“å°èˆªæ¬„å›ºå®šä½ */
    top: 0;               /* è²¼ç·Šæœ€ä¸Šæ–¹ */
    left: 0;              /* è²¼ç·Šæœ€å·¦é‚Š */
    width: 100%;          /* å¯¬åº¦æ’æ»¿æ•´å€‹è¢å¹• */
    height: 60px;         /* è¨­å®šé«˜åº¦ */
    background: white;    /* èƒŒæ™¯ç™½è‰² */
    display: flex;        /* è®“è£¡é¢çš„æ±è¥¿æ’æˆä¸€æ©«æ’ */
    align-items: center;  /* å‚ç›´å±…ä¸­ */
    padding: 0 20px;      /* å·¦å³ç•™é»é‚Šè· */
    box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* åŠ ä¸€é»é»é™°å½±ï¼Œçœ‹èµ·ä¾†æ›´å°ˆæ¥­ */
    z-index: 1000;        /* ç¢ºä¿å®ƒç–Šåœ¨æ‰€æœ‰æ±è¥¿çš„æœ€ä¸Šé¢ */
    font-family: sans-serif;
">
    <img src="../school logo.png" style="height: 40px; margin-right: 15px;">

    <span style="font-weight: bold; color: #333; flex-grow: 1;">
      ç­æˆ¿èª¿ä½å·¥å…·
    </span>

    <a href="../index.html" style="
        text-decoration: none;
        background: #4A90E2;
        color: white;
        padding: 8px 15px;
        border-radius: 5px;
        font-size: 14px;
    ">ğŸ  è¿”å›ä¸»é </a>
</nav>
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šèª¿ä½å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ html2canvas åº«ç”¨æ–¼åœ–ç‰‡ç”Ÿæˆ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        .classroom-grid {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            min-height: 480px;
        }
        .column-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .seat {
            width: 100px;
            height: 90px;
            border: 2px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            cursor: move;
            font-weight: bold;
            transition: transform 0.2s;
            text-align: center;
            padding: 5px;
            word-break: break-all;
            font-size: 0.9rem;
            user-select: none;
        }
        .seat:hover { background-color: #f0fdf4; }
        .seat.dragging { opacity: 0.5; transform: scale(1.05); }
        .seat.drag-over { background-color: #dcfce7; border-color: #22c55e; }
        .empty-seat { color: #ccc; font-weight: normal; font-size: 0.7rem; }
        
        .feature-box {
            border: 2px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fafafa;
        }
        .door-arc {
            width: 80px;
            height: 80px;
            border-left: 2px solid #333;
            border-bottom: 2px solid #333;
            border-bottom-left-radius: 100%;
            position: absolute;
            right: 20px;
            bottom: 20px;
        }

        #pdfWrapper {
            background: white;
            width: 1100px; 
            margin: 0 auto;
        }

        @media screen and (max-width: 1100px) {
            #pdfWrapper {
                width: 100%;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">

    <div class="max-w-6xl mx-auto bg-white shadow-2xl rounded-xl p-4 md:p-8 no-print">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">ç­ç´šèª¿ä½å·¥å…·</h1>
        
        <!-- ç”¨æ³•æç¤º -->
        <div class="mb-6 p-4 bg-amber-50 border-l-4 border-amber-400 rounded text-sm text-amber-900">
            <h2 class="font-bold mb-1 flex items-center">
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                æ“ä½œèªªæ˜ï¼š
            </h2>
            <p>1. å¡«å¯«é ‚éƒ¨è³‡è¨Šã€‚ 2. åŒ¯å…¥å­¸ç”Ÿæ¸…å–®ã€‚ 3. <strong>æ‹–å‹•åº§ä½</strong>äº¤æ›ä½ç½®ã€‚ 4. é»æ“Šã€Œä¸‹è¼‰åœ–ç‰‡ã€å³å¯ä¿å­˜ JPGã€‚</p>
        </div>

        <!-- æ§åˆ¶å€åŸŸ -->
        <div class="space-y-4 bg-blue-50 p-6 rounded-lg mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="inputClassName" placeholder="ç­åˆ¥ (å¦‚: 5C)" class="border p-2 rounded focus:ring-2 focus:ring-blue-400 outline-none" oninput="updateInfo()">
                <input type="text" id="inputTeachers" placeholder="ç­ä¸»ä»»" class="border p-2 rounded focus:ring-2 focus:ring-blue-400 outline-none" oninput="updateInfo()">
                <input type="text" id="inputMonitors" placeholder="ç­é•·" class="border p-2 rounded focus:ring-2 focus:ring-blue-400 outline-none" oninput="updateInfo()">
            </div>
            <div class="flex flex-wrap items-center gap-4">
                <div class="flex items-center gap-2">
                    <span class="text-sm font-medium">åº§ä½ç¸½æ•¸:</span>
                    <select id="seatCount" class="border p-2 rounded bg-white" onchange="renderSeats()">
                        <option value="28">28</option>
                        <option value="30" selected>30</option>
                        <option value="32">32</option>
                        <option value="34">34</option>
                    </select>
                </div>
                <input type="file" id="csvInput" accept=".csv,.txt" class="text-sm flex-1 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-600 file:text-white hover:file:bg-blue-700 cursor-pointer">
                <div class="flex gap-2">
                    <button id="downloadBtn" onclick="downloadImage()" class="bg-green-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-green-700 shadow-md transition-all">ä¸‹è¼‰åœ–ç‰‡ (JPG)</button>
                    <button onclick="clearAll()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 shadow-sm">æ¸…ç©º</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¯è¦–åŒ–å€åŸŸ -->
    <div id="pdfWrapper" class="bg-white">
        <div id="captureArea" class="relative p-10 bg-white border border-transparent">
            
            <!-- æŠ¬é ­è³‡è¨Š -->
            <div class="flex justify-between items-start mb-8">
                <div class="text-xl space-y-1">
                    <p>ç­ä¸»ä»»ï¼š<span id="displayTeachers"></span></p>
                    <p>ç­é•·ï¼š<span id="displayMonitors"></span></p>
                </div>
                <div id="displayClassName" class="text-8xl font-serif italic font-black text-gray-900 leading-none"></div>
                <div class="w-40"></div> 
            </div>

            <!-- æ•™å®¤å…§å®¹ -->
            <div class="flex gap-10 justify-center items-start">
                <div class="feature-box w-12 h-[540px] flex-col text-xl font-bold text-gray-700" style="writing-mode: vertical-rl;">
                    å„² ç‰© æ«ƒ
                </div>

                <div id="seatingArea" class="classroom-grid">
                    <!-- Seats generated here -->
                </div>
            </div>

            <!-- åº•éƒ¨è¨­æ–½ -->
            <div class="mt-12 flex justify-between items-end">
                <div class="feature-box w-40 h-20 text-xl font-bold text-gray-700">è€å¸«æ±</div>
                <div class="feature-box w-1/2 h-16 text-3xl font-bold tracking-[1rem] text-gray-800">é»‘ æ¿</div>
                <div class="relative w-28 h-28 text-gray-700">
                    <div class="absolute top-0 right-0 text-sm font-bold">é–€å£</div>
                    <div class="door-arc"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let students = [];
        const seatingArea = document.getElementById('seatingArea');
        const seatCountSelect = document.getElementById('seatCount');
        const csvInput = document.getElementById('csvInput');

        function updateInfo() {
            document.getElementById('displayClassName').innerText = document.getElementById('inputClassName').value;
            document.getElementById('displayTeachers').innerText = document.getElementById('inputTeachers').value;
            document.getElementById('displayMonitors').innerText = document.getElementById('inputMonitors').value;
        }

        window.onload = () => {
            renderSeats();
            csvInput.addEventListener('change', handleFileUpload);
        };

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                students = event.target.result.split(/\r?\n/)
                    .map(line => line.split(',')[0].trim())
                    .filter(name => name !== "");
                renderSeats();
            };
            reader.readAsText(file);
        }

        function renderSeats() {
            const totalSeats = parseInt(seatCountSelect.value);
            seatingArea.innerHTML = '';
            const numCols = 6; 
            const baseRowsPerCol = Math.floor(totalSeats / numCols);
            const extraSeats = totalSeats % numCols;

            for (let c = 0; c < numCols; c++) {
                const colDiv = document.createElement('div');
                colDiv.className = 'column-group';
                const rowsInThisCol = c < extraSeats ? baseRowsPerCol + 1 : baseRowsPerCol;

                for (let r = 0; r < rowsInThisCol; r++) {
                    let currentIdx = 0;
                    for(let prevCol = 0; prevCol < c; prevCol++) {
                        currentIdx += (prevCol < extraSeats ? baseRowsPerCol + 1 : baseRowsPerCol);
                    }
                    currentIdx += r;

                    const seat = document.createElement('div');
                    seat.className = 'seat';
                    seat.draggable = true;
                    seat.dataset.index = currentIdx;
                    
                    const name = students[currentIdx] || "";
                    seat.innerHTML = name ? name : `<span class="empty-seat">ç©ºç½®</span>`;
                    
                    seat.addEventListener('dragstart', handleDragStart);
                    seat.addEventListener('dragover', handleDragOver);
                    seat.addEventListener('dragleave', handleDragLeave);
                    seat.addEventListener('drop', handleDrop);
                    seat.addEventListener('dragend', handleDragEnd);
                    colDiv.appendChild(seat);
                }
                seatingArea.appendChild(colDiv);
            }
        }

        let draggedIdx = null;
        function handleDragStart(e) { draggedIdx = this.dataset.index; this.classList.add('dragging'); }
        function handleDragOver(e) { e.preventDefault(); this.classList.add('drag-over'); }
        function handleDragLeave() { this.classList.remove('drag-over'); }
        function handleDrop(e) {
            this.classList.remove('drag-over');
            const targetIdx = this.dataset.index;
            if (draggedIdx !== null && draggedIdx !== targetIdx) {
                const max = Math.max(draggedIdx, targetIdx);
                while(students.length <= max) students.push("");
                [students[draggedIdx], students[targetIdx]] = [students[targetIdx], students[draggedIdx]];
                renderSeats();
            }
        }
        function handleDragEnd() { this.classList.remove('dragging'); }

        function clearAll() { if (confirm('ç¢ºå®šæ¸…ç©ºï¼Ÿ')) { students = []; renderSeats(); } }

        /**
         * ä¸‹è¼‰ç‚ºåœ–ç‰‡ (JPG) æ ¼å¼
         */
        async function downloadImage() {
            const captureArea = document.getElementById('captureArea');
            const btn = document.getElementById('downloadBtn');
            const className = document.getElementById('inputClassName').value || "ç­ç´š";
            
            btn.disabled = true;
            btn.innerText = "ç”Ÿæˆåœ–ç‰‡ä¸­...";

            // ç¢ºä¿æ²å‹•åˆ°é ‚éƒ¨ï¼Œé¿å… html2canvas æ•æ‰ç¯„åœåç§»
            window.scrollTo(0,0);

            try {
                // ä½¿ç”¨ html2canvas é€²è¡Œæ•æ‰
                const canvas = await html2canvas(captureArea, {
                    scale: 2, // æé«˜è§£æåº¦
                    backgroundColor: "#ffffff",
                    useCORS: true,
                    logging: false,
                    width: 1100, // å¼·åˆ¶å›ºå®šå¯¬åº¦
                    windowWidth: 1100
                });

                // å°‡ canvas è½‰ç‚º JPG
                const imgData = canvas.toDataURL("image/jpeg", 0.9);
                
                // è§¸ç™¼ä¸‹è¼‰
                const link = document.createElement('a');
                link.href = imgData;
                link.download = `${className}_åº§ä½è¡¨.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (err) {
                console.error("åœ–ç‰‡ä¸‹è¼‰å¤±æ•—:", err);
                alert("ç”Ÿæˆåœ–ç‰‡å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ¬Šé™");
            } finally {
                btn.disabled = false;
                btn.innerText = "ä¸‹è¼‰åœ–ç‰‡ (JPG)";
            }
        }
    </script>
</body>
</html>
